# 阿瓦隆游戏部署方案总结

## 一、服务器推荐

### 选择：轻量应用服务器 2vCPU 4GiB（预装 Docker CE）✅

**配置评估：**
- CPU: 2核 - 足够运行 Node.js 后端和 nginx 前端
- 内存: 4GB - 可支持 100+ 并发玩家
- 预估资源使用：
  - 后端服务：300-500MB
  - 前端服务：50-100MB
  - WebSocket：每 100 个玩家约 1MB
  - 系统开销：500MB
  - **总计：1-2GB，余量充足**

**为什么选 Docker 版本：**
1. ✅ 一键部署，减少配置错误
2. ✅ 容器隔离，互不影响
3. ✅ 易于回滚和更新
4. ✅ 可扩展性强（未来可添加数据库、缓存等）

---

## 二、已创建的部署文件

我已经为你创建了完整的部署配置：

### 1. Docker 配置文件

| 文件 | 位置 | 用途 |
|------|------|------|
| `Dockerfile` | `packages/server/` | 后端服务容器化配置 |
| `Dockerfile` | `packages/client/` | 前端服务容器化配置 |
| `docker-compose.yml` | 项目根目录 | 服务编排配置 |
| `.dockerignore` | 项目根目录 | 优化构建速度 |

### 2. Web 服务器配置

| 文件 | 位置 | 用途 |
|------|------|------|
| `nginx.conf` | `packages/client/` | Nginx 反向代理配置，处理静态文件和 API/WebSocket 代理 |

### 3. 环境配置

| 文件 | 位置 | 用途 |
|------|------|------|
| `.env.production` | 项目根目录 | 生产环境变量模板 |

### 4. 部署脚本

| 文件 | 用途 |
|------|------|
| `deploy.sh` | Linux 服务器一键部署脚本 |
| `deploy.ps1` | Windows 本地测试脚本 |

### 5. 文档

| 文件 | 内容 |
|------|------|
| `DEPLOYMENT.md` | 详细的部署指南（15个章节） |
| `QUICK_START.md` | 快速开始指南 |
| `部署方案总结.md` | 本文档 |

---

## 三、部署架构图

```
                          互联网
                             |
                    [阿里云服务器公网IP]
                             |
                        端口 80
                             |
                    ┌────────▼─────────┐
                    │  Nginx 容器      │
                    │  (前端 + 代理)   │
                    └────────┬─────────┘
                             │
                    ┌────────┴─────────┐
                    │                  │
              /api, /ws          静态文件 (HTML, JS, CSS)
                    │                  │
         ┌──────────▼───────┐          │
         │  Node.js 容器    │          │
         │  (后端 API +     │          │
         │   WebSocket)     │          │
         └──────────────────┘          │
                                       │
                                浏览器直接加载
```

**请求流程：**
1. 用户访问 `http://服务器IP`
2. Nginx 返回前端静态文件（React 应用）
3. 前端向 `/api/*` 发送请求 → Nginx 代理到后端容器
4. 前端向 `/ws` 建立 WebSocket → Nginx 代理到后端容器
5. 后端处理游戏逻辑，返回结果

---

## 四、部署步骤速览

### 本地测试（推荐先在本地测试）

```powershell
# Windows 用户
.\deploy.ps1

# 浏览器访问: http://localhost
```

### 部署到阿里云

```bash
# 1. SSH 连接服务器
ssh root@你的服务器IP

# 2. 上传代码（选择一种方式）
# 方式A: Git（推荐）
git clone https://github.com/你的仓库.git
cd 项目名

# 方式B: SCP 上传
# (在本地执行) scp -r 项目文件夹 root@IP:/root/apps/avalon-game

# 3. 配置环境变量
cp .env.production .env
nano .env  # 修改 JWT_SECRET

# 4. 一键部署
chmod +x deploy.sh
./deploy.sh

# 5. 访问游戏
# 浏览器: http://你的服务器IP
```

---

## 五、关键配置说明

### 1. JWT_SECRET（重要！）

**位置**：`.env` 文件

**默认值**：`your-super-secret-jwt-key-change-this-to-random-string`

**必须修改**：生产环境务必修改为强密码（至少 32 位随机字符）

**生成方法**：
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 2. 端口配置

| 服务 | 内部端口 | 外部端口 | 说明 |
|------|---------|---------|------|
| 前端 (nginx) | 80 | 80 | 用户直接访问 |
| 后端 (Node.js) | 3001 | 3001 | 可选暴露，调试用 |

### 3. 防火墙配置

```bash
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 443   # HTTPS（可选）
sudo ufw enable
```

---

## 六、常用管理命令

```bash
# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 重启服务
docker-compose restart

# 停止服务
docker-compose down

# 更新代码
git pull
docker-compose down
docker-compose build
docker-compose up -d

# 查看资源使用
docker stats
```

---

## 七、性能优化要点

### 已自动配置：
1. ✅ Gzip 压缩（nginx.conf）
2. ✅ 静态资源缓存（1年）
3. ✅ WebSocket 长连接支持
4. ✅ 健康检查机制

### 可选优化：
1. 配置 CDN 加速静态资源
2. 启用 HTTP/2
3. 配置 SSL/HTTPS
4. 添加 Redis 缓存（用户会话）
5. 添加数据库（持久化游戏数据）

---

## 八、安全建议

### 基础安全（推荐）：
1. ✅ 修改 JWT_SECRET 为强密码
2. ✅ 配置防火墙
3. ✅ 定期更新系统和 Docker

### 高级安全（可选）：
1. 配置 HTTPS（Let's Encrypt 免费证书）
2. 修改 SSH 端口
3. 禁用 root 登录
4. 配置 fail2ban 防暴力破解
5. 设置日志轮转

详见：`DEPLOYMENT.md` 第 12 章节

---

## 九、故障排查

### 问题 1：无法访问网站

```bash
# 检查容器状态
docker-compose ps

# 检查日志
docker-compose logs

# 检查防火墙
sudo ufw status

# 检查端口
sudo netstat -tlnp | grep 80
```

### 问题 2：WebSocket 连接失败

```bash
# 查看 nginx 配置
docker exec avalon-client cat /etc/nginx/conf.d/default.conf

# 查看后端日志
docker-compose logs server | grep -i websocket
```

### 问题 3：内存不足

```bash
# 查看内存使用
free -h

# 添加 Swap（如需要）
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

更多故障排查见：`DEPLOYMENT.md` 第 11 章节

---

## 十、成本估算

### 服务器成本
- 阿里云轻量应用服务器 2C4G：约 **¥70-90/月**
- 带宽：通常包含 1-5Mbps（足够小型游戏）

### 其他成本
- 域名（可选）：约 ¥50-100/年
- SSL 证书：免费（Let's Encrypt）或 ¥100-500/年

### 总计
- **最低配置**：¥70-90/月（仅服务器）
- **推荐配置**：¥80-100/月（服务器 + 域名分摊）

---

## 十一、扩展建议

### 当前架构支持的规模：
- 并发玩家：100-200 人
- 游戏房间：20-30 个
- 响应时间：<100ms

### 如需扩展：
1. **垂直扩展**：升级到 4C8G 服务器（支持 500+ 玩家）
2. **水平扩展**：
   - 添加负载均衡器
   - 部署多个后端实例
   - 使用 Redis 共享会话
   - 使用数据库持久化数据

---

## 十二、下一步行动清单

### 立即执行：
- [ ] 购买阿里云服务器（Docker CE 版本）
- [ ] 记录服务器 IP 和登录信息
- [ ] 在本地测试部署（运行 `deploy.ps1`）
- [ ] 将代码推送到 Git 仓库（GitHub/GitLab）

### 服务器配置：
- [ ] SSH 连接到服务器
- [ ] 克隆代码到服务器
- [ ] 修改 `.env` 中的 JWT_SECRET
- [ ] 运行 `deploy.sh` 部署
- [ ] 在浏览器访问服务器 IP 验证

### 优化和加固：
- [ ] 配置域名（可选）
- [ ] 配置 HTTPS（推荐）
- [ ] 设置定时备份
- [ ] 配置监控告警

---

## 十三、获取帮助

### 文档资源：
1. **快速开始**：`QUICK_START.md`
2. **详细指南**：`DEPLOYMENT.md`（15 个章节，50+ 页）
3. **本总结**：`部署方案总结.md`

### 命令速查：
```bash
# 启动
docker-compose up -d

# 停止
docker-compose down

# 查看日志
docker-compose logs -f

# 查看状态
docker-compose ps

# 进入容器调试
docker exec -it avalon-server sh
```

---

## 总结

你现在拥有：
1. ✅ 完整的 Docker 配置文件
2. ✅ 自动化部署脚本
3. ✅ 详细的部署文档
4. ✅ 故障排查指南
5. ✅ 性能优化建议

**准备部署？**
1. 本地测试：`.\deploy.ps1`
2. 阿里云部署：`./deploy.sh`
3. 遇到问题：查看 `DEPLOYMENT.md`

**祝部署顺利！🚀**

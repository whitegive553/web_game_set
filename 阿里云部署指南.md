# é˜¿é‡Œäº‘è½»é‡åº”ç”¨æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—

## é€‚ç”¨ç¯å¢ƒ

- **æœåŠ¡å™¨ç±»å‹**ï¼šé˜¿é‡Œäº‘è½»é‡åº”ç”¨æœåŠ¡å™¨ï¼ˆé¢„è£… Docker CEï¼‰
- **æ“ä½œç³»ç»Ÿ**ï¼šAlibaba Cloud Linux 3.2104ï¼ˆåŸºäº RHEL/CentOSï¼‰
- **åŒ…ç®¡ç†å™¨**ï¼šyum
- **é˜²ç«å¢™**ï¼šfirewalld

---

## å¿«é€Ÿéƒ¨ç½²ï¼ˆ5 åˆ†é’Ÿï¼‰

### 1. SSH è¿æ¥æœåŠ¡å™¨

```bash
ssh root@ä½ çš„æœåŠ¡å™¨å…¬ç½‘IP
```

### 2. ä¸Šä¼ ä»£ç 

**æ–¹å¼ Aï¼šä½¿ç”¨ Gitï¼ˆæ¨èï¼‰**
```bash
cd /root
mkdir -p apps
cd apps
git clone https://github.com/ä½ çš„ç”¨æˆ·å/ä»“åº“å.git avalon-game
cd avalon-game
```

**æ–¹å¼ Bï¼šä»æœ¬åœ°ä¸Šä¼ **
```powershell
# åœ¨æœ¬åœ° Windows PowerShell æ‰§è¡Œ
scp -r C:\aipengze\web_llm root@ä½ çš„æœåŠ¡å™¨IP:/root/apps/avalon-game
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
cd /root/apps/avalon-game

# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.production .env

# ç”Ÿæˆéšæœº JWT å¯†é’¥
JWT_SECRET=$(node -e "console.log(require('crypto').randomBytes(32).toString('hex'))")

# è‡ªåŠ¨æ›¿æ¢
sed -i "s/your-super-secret-jwt-key-change-this-to-random-string/$JWT_SECRET/g" .env

# éªŒè¯é…ç½®
cat .env
```

### 4. é…ç½®é˜²ç«å¢™

```bash
# å¯åŠ¨é˜²ç«å¢™
systemctl start firewalld
systemctl enable firewalld

# å¼€æ”¾ç«¯å£
firewall-cmd --permanent --add-port=22/tcp    # SSH
firewall-cmd --permanent --add-port=80/tcp    # HTTP
firewall-cmd --permanent --add-port=443/tcp   # HTTPSï¼ˆå¯é€‰ï¼‰

# é‡æ–°åŠ è½½
firewall-cmd --reload

# éªŒè¯
firewall-cmd --list-ports
```

### 5. ä¸€é”®éƒ¨ç½²

```bash
# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x deploy.sh

# è¿è¡Œéƒ¨ç½²è„šæœ¬ï¼ˆè‡ªåŠ¨æ£€æµ‹ yum ç³»ç»Ÿï¼‰
./deploy.sh
```

### 6. éªŒè¯éƒ¨ç½²

éƒ¨ç½²å®Œæˆåï¼Œæµè§ˆå™¨è®¿é—®ï¼š
```
http://ä½ çš„æœåŠ¡å™¨å…¬ç½‘IP
```

---

## é˜¿é‡Œäº‘ç‰¹å®šå‘½ä»¤

### ç³»ç»Ÿç®¡ç†

```bash
# æ›´æ–°ç³»ç»Ÿ
yum update -y

# å®‰è£…è½¯ä»¶
yum install -y è½¯ä»¶å

# æŸ¥çœ‹å·²å®‰è£…è½¯ä»¶
yum list installed | grep è½¯ä»¶å

# æœç´¢è½¯ä»¶åŒ…
yum search å…³é”®è¯
```

### é˜²ç«å¢™ç®¡ç†

```bash
# æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€
systemctl status firewalld

# æŸ¥çœ‹å¼€æ”¾çš„ç«¯å£
firewall-cmd --list-ports

# å¼€æ”¾ç«¯å£ï¼ˆä¸´æ—¶ï¼‰
firewall-cmd --add-port=ç«¯å£å·/tcp

# å¼€æ”¾ç«¯å£ï¼ˆæ°¸ä¹…ï¼‰
firewall-cmd --permanent --add-port=ç«¯å£å·/tcp
firewall-cmd --reload

# å…³é—­ç«¯å£
firewall-cmd --permanent --remove-port=ç«¯å£å·/tcp
firewall-cmd --reload

# æŸ¥çœ‹æ‰€æœ‰è§„åˆ™
firewall-cmd --list-all
```

### æœåŠ¡ç®¡ç†

```bash
# å¯åŠ¨ Docker
systemctl start docker

# åœæ­¢ Docker
systemctl stop docker

# é‡å¯ Docker
systemctl restart docker

# æŸ¥çœ‹ Docker çŠ¶æ€
systemctl status docker

# å¼€æœºè‡ªå¯
systemctl enable docker
```

---

## å¸¸è§é—®é¢˜ï¼ˆé˜¿é‡Œäº‘ç‰ˆï¼‰

### é—®é¢˜ 1ï¼šdocker-compose å‘½ä»¤ä¸å­˜åœ¨

**è§£å†³æ–¹æ³•ï¼š**
```bash
# deploy.sh ä¼šè‡ªåŠ¨å®‰è£…ï¼Œæ‰‹åŠ¨å®‰è£…æ–¹æ³•ï¼š

# æ–¹æ³• Aï¼šä» yum å®‰è£…ï¼ˆå¯èƒ½æ²¡æœ‰ï¼‰
yum install -y docker-compose

# æ–¹æ³• Bï¼šä» GitHub ä¸‹è½½ï¼ˆæ¨èï¼‰
COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep -Po '"tag_name": "\K.*?(?=")')
curl -L "https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose

# éªŒè¯
docker-compose --version
```

### é—®é¢˜ 2ï¼šç«¯å£æ— æ³•è®¿é—®

```bash
# 1. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
firewall-cmd --list-ports

# 2. æ£€æŸ¥ç«¯å£ç›‘å¬
ss -tlnp | grep -E '80|3001'

# 3. æ£€æŸ¥é˜¿é‡Œäº‘æ§åˆ¶å°çš„å®‰å…¨ç»„è§„åˆ™
# ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å° â†’ è½»é‡åº”ç”¨æœåŠ¡å™¨ â†’ é˜²ç«å¢™
# ç¡®ä¿å·²å¼€æ”¾ 80 ç«¯å£
```

### é—®é¢˜ 3ï¼šGit å…‹éš†å¤±è´¥

```bash
# å®‰è£… Git
yum install -y git

# éªŒè¯
git --version

# é…ç½® Gitï¼ˆå¯é€‰ï¼‰
git config --global user.name "Your Name"
git config --global user.email "your.email@example.com"
```

### é—®é¢˜ 4ï¼šNode.js å‘½ä»¤ä¸å¯ç”¨

```bash
# Docker å®¹å™¨å†…å·²åŒ…å« Node.jsï¼Œæ— éœ€åœ¨ä¸»æœºå®‰è£…
# å¦‚éœ€åœ¨ä¸»æœºä½¿ç”¨ Node.jsï¼ˆç”Ÿæˆ JWT_SECRETï¼‰ï¼š

# å®‰è£… Node.js
curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
yum install -y nodejs

# éªŒè¯
node --version
npm --version
```

### é—®é¢˜ 5ï¼šå†…å­˜ä¸è¶³

```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# åˆ›å»º Swapï¼ˆ2GBï¼‰
dd if=/dev/zero of=/swapfile bs=1M count=2048
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile

# æ°¸ä¹…ç”Ÿæ•ˆ
echo '/swapfile none swap sw 0 0' >> /etc/fstab

# éªŒè¯
free -h
```

---

## é˜¿é‡Œäº‘æ§åˆ¶å°é…ç½®

### 1. å®‰å…¨ç»„/é˜²ç«å¢™è§„åˆ™

ç™»å½•é˜¿é‡Œäº‘æ§åˆ¶å°ï¼š
1. è¿›å…¥ **è½»é‡åº”ç”¨æœåŠ¡å™¨** æ§åˆ¶å°
2. é€‰æ‹©ä½ çš„æœåŠ¡å™¨å®ä¾‹
3. ç‚¹å‡» **é˜²ç«å¢™** æ ‡ç­¾
4. æ·»åŠ è§„åˆ™ï¼š
   - ç«¯å£ï¼š80
   - åè®®ï¼šTCP
   - å…è®¸æ‰€æœ‰ IP è®¿é—®

### 2. é‡ç½®å¯†ç 

å¦‚æœå¿˜è®° root å¯†ç ï¼š
1. é˜¿é‡Œäº‘æ§åˆ¶å° â†’ è½»é‡åº”ç”¨æœåŠ¡å™¨
2. å®ä¾‹åˆ—è¡¨ â†’ è¿œç¨‹è¿æ¥ â†’ é‡ç½®å¯†ç 

### 3. å¿«ç…§å¤‡ä»½

å»ºè®®å®šæœŸåˆ›å»ºå¿«ç…§ï¼š
1. æ§åˆ¶å° â†’ å¿«ç…§
2. åˆ›å»ºå¿«ç…§
3. å¯è®¾ç½®è‡ªåŠ¨å¿«ç…§ç­–ç•¥

---

## æ€§èƒ½ç›‘æ§

### ç³»ç»Ÿèµ„æºç›‘æ§

```bash
# å®æ—¶æŸ¥çœ‹ CPUã€å†…å­˜ã€è´Ÿè½½
top

# æŸ¥çœ‹å†…å­˜è¯¦æƒ…
free -h

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹ç½‘ç»œè¿æ¥
ss -s
```

### Docker èµ„æºç›‘æ§

```bash
# å®æ—¶æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—å¤§å°
docker system df
```

### æ—¥å¿—æŸ¥çœ‹

```bash
# ç³»ç»Ÿæ—¥å¿—
journalctl -xe

# Docker æ—¥å¿—
journalctl -u docker

# åº”ç”¨æ—¥å¿—
docker-compose logs -f --tail=100
```

---

## ä¼˜åŒ–å»ºè®®

### 1. ç³»ç»Ÿä¼˜åŒ–

```bash
# ä¼˜åŒ–æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
cat >> /etc/security/limits.conf << EOF
* soft nofile 65535
* hard nofile 65535
EOF

# ä¼˜åŒ–å†…æ ¸å‚æ•°
cat >> /etc/sysctl.conf << EOF
net.core.somaxconn = 1024
net.ipv4.tcp_max_syn_backlog = 2048
net.ipv4.ip_local_port_range = 10000 65000
EOF

sysctl -p
```

### 2. Docker æ—¥å¿—é™åˆ¶

```bash
# ç¼–è¾‘ Docker é…ç½®
cat > /etc/docker/daemon.json << EOF
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
EOF

# é‡å¯ Docker
systemctl restart docker

# é‡å¯åº”ç”¨
cd /root/apps/avalon-game
docker-compose restart
```

### 3. å®šæœŸæ¸…ç†

```bash
# åˆ›å»ºæ¸…ç†è„šæœ¬
cat > /root/cleanup.sh << 'EOF'
#!/bin/bash
# æ¸…ç† Docker èµ„æº
docker system prune -af --volumes

# æ¸…ç†æ—¥å¿—
journalctl --vacuum-time=7d

echo "æ¸…ç†å®Œæˆï¼"
EOF

chmod +x /root/cleanup.sh

# è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å‘¨æ—¥å‡Œæ™¨ 3 ç‚¹ï¼‰
(crontab -l 2>/dev/null; echo "0 3 * * 0 /root/cleanup.sh") | crontab -
```

---

## å‡çº§å’Œç»´æŠ¤

### æ›´æ–°åº”ç”¨ä»£ç 

```bash
cd /root/apps/avalon-game

# æ‹‰å–æœ€æ–°ä»£ç 
git pull

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose down
docker-compose build
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

### ç³»ç»Ÿæ›´æ–°

```bash
# æ›´æ–°ç³»ç»ŸåŒ…
yum update -y

# é‡å¯æœåŠ¡å™¨ï¼ˆå¦‚éœ€è¦ï¼‰
reboot
```

---

## å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# é‡å¯æœåŠ¡
docker-compose restart

# åœæ­¢æœåŠ¡
docker-compose down

# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹é˜²ç«å¢™
firewall-cmd --list-ports

# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats

# è¿›å…¥å®¹å™¨
docker exec -it avalon-server sh
```

---

## æŠ€æœ¯æ”¯æŒ

é‡åˆ°é—®é¢˜ï¼Ÿ
1. æŸ¥çœ‹æ—¥å¿—ï¼š`docker-compose logs -f`
2. æ£€æŸ¥çŠ¶æ€ï¼š`docker-compose ps`
3. æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£ï¼š`cat DEPLOYMENT.md`
4. é˜²ç«å¢™é—®é¢˜ï¼šæ£€æŸ¥é˜¿é‡Œäº‘æ§åˆ¶å°çš„å®‰å…¨ç»„è§„åˆ™

---

**éƒ¨ç½²æˆåŠŸåï¼Œè®°å¾—ï¼š**
- âœ… é…ç½®åŸŸåï¼ˆå¯é€‰ï¼‰
- âœ… å¯ç”¨ HTTPSï¼ˆæ¨èï¼‰
- âœ… è®¾ç½®å®šæœŸå¤‡ä»½
- âœ… é…ç½®ç›‘æ§å‘Šè­¦

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼ğŸš€**

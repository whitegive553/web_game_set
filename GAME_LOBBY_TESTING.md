# 游戏大厅测试指南

## 环境准备

### 1. 配置环境变量 (重要！)

**客户端环境变量配置**

```bash
cd packages/client

# 如果 .env 文件不存在，会自动使用正确的配置
# 但建议检查一下确保配置正确
cat .env
```

`.env` 文件应包含以下内容：
```env
VITE_API_BASE=http://localhost:3001/api/game
VITE_WS_URL=ws://localhost:3001/ws
VITE_API_URL=http://localhost:3001
```

**注意**: 如果你修改了环境变量，必须重启客户端开发服务器才能生效！

### 2. 启动服务器

```bash
cd packages/server
npm run dev
```

服务器将在以下端口启动：
- HTTP API: `http://localhost:3001`
- WebSocket: `ws://localhost:3001/ws`

### 3. 启动客户端

```bash
cd packages/client
npm run dev
```

客户端将在 `http://localhost:5173` 启动（Vite 默认端口）

---

## 测试流程

### 步骤 1: 创建测试账号

1. 访问 `http://localhost:3000`
2. 注册至少 6 个测试账号：
   - player1 / 123456
   - player2 / 123456
   - player3 / 123456
   - player4 / 123456
   - player5 / 123456
   - player6 / 123456

### 步骤 2: 进入游戏大厅

1. 使用 player1 登录
2. 在主菜单点击 **"多人游戏大厅"**
3. 你将看到游戏选择界面（阿瓦隆 / 文字冒险）

### 步骤 3: 创建房间

1. 确保选中 **"阿瓦隆"** 游戏
2. 点击 **"创建房间"** 按钮
3. 输入房间名称（如："测试房间1"）
4. 设置最大玩家数（6-10）
5. 点击 **"创建"**

### 步骤 4: 其他玩家加入

在不同浏览器或隐身窗口中：

1. 使用 player2 登录并进入游戏大厅
2. 在房间列表中找到 "测试房间1"
3. 点击 **"加入"** 按钮
4. 重复此过程，让 player3-6 也加入房间

**注意**: 你应该能实时看到新玩家加入房间！

### 步骤 5: 玩家准备

每个玩家（除了房主）：

1. 进入房间等待界面后
2. 点击 **"准备"** 按钮
3. 你的状态会变为绿色，显示 "✓ 已准备"

**注意**: 房主不需要点击准备，但房主必须等所有人都准备好

### 步骤 6: 开始游戏

房主（player1）：

1. 当所有玩家都准备好时
2. **"开始游戏"** 按钮会变为可用状态
3. 点击开始游戏

**注意**: 游戏将自动跳转到游戏界面（待实现）

---

## 功能测试清单

### 游戏大厅功能

- [ ] **游戏选择**
  - [ ] 可以切换阿瓦隆和文字冒险
  - [ ] 房间列表根据选择的游戏过滤

- [ ] **创建房间**
  - [ ] 可以输入房间名称
  - [ ] 可以设置玩家数量（6-10）
  - [ ] 创建后自动加入房间

- [ ] **房间列表**
  - [ ] 显示所有可用房间
  - [ ] 实时更新（玩家加入/离开时）
  - [ ] 显示玩家数量和房主
  - [ ] 显示玩家准备状态

- [ ] **加入房间**
  - [ ] 可以加入未满的房间
  - [ ] 房间满后无法加入
  - [ ] 游戏中的房间无法加入

### 阿瓦隆房间功能

- [ ] **房间信息**
  - [ ] 显示房主、玩家数量
  - [ ] 显示游戏状态（等待中/游戏中）

- [ ] **玩家列表**
  - [ ] 显示所有玩家头像和名字
  - [ ] 房主有特殊标记
  - [ ] 准备状态实时更新
  - [ ] 准备的玩家显示绿色背景

- [ ] **准备系统**
  - [ ] 非房主玩家可以切换准备状态
  - [ ] 准备状态实时同步给所有人

- [ ] **开始游戏**
  - [ ] 只有房主可以看到开始按钮
  - [ ] 需要 6-10 名玩家
  - [ ] 需要所有人都准备
  - [ ] 满足条件后可以启动游戏

- [ ] **离开房间**
  - [ ] 可以随时离开房间
  - [ ] 离开后返回大厅
  - [ ] 如果房主离开，房主权限转移给下一位玩家

### WebSocket 实时功能

- [ ] **连接状态**
  - [ ] 进入大厅时自动连接 WebSocket
  - [ ] 离开大厅时断开连接
  - [ ] 连接失败时显示错误信息

- [ ] **实时更新**
  - [ ] 玩家加入房间 → 所有人看到新玩家
  - [ ] 玩家离开房间 → 所有人看到玩家移除
  - [ ] 玩家切换准备 → 所有人看到状态变化
  - [ ] 房间创建/删除 → 大厅列表实时更新

---

## 常见问题排查

### 0. 无法选择游戏或创建房间（最常见）

**症状**:
- 点击游戏卡片没有反应
- 点击"创建房间"按钮没有反应
- 界面显示正常但无法交互

**原因**: 环境变量配置错误或未重启服务器

**解决**:
1. 确认 `packages/client/.env` 文件存在
2. 确认文件内容正确（使用 `VITE_` 前缀，不是 `REACT_APP_`）
3. **重启客户端开发服务器**（Ctrl+C 然后重新运行 `npm run dev`）
4. 清除浏览器缓存并刷新页面（Ctrl+Shift+R）
5. 打开浏览器开发者工具 → Console，查看是否有错误信息

### 1. WebSocket 连接失败

**症状**: 控制台显示 "Failed to connect to server"

**解决**:
- 确认服务器正在运行
- 检查端口 3001 是否被占用
- 查看服务器日志是否有错误

### 2. 房间列表不更新

**症状**: 创建房间后，其他人看不到

**解决**:
- 刷新页面
- 检查 WebSocket 连接状态
- 查看浏览器开发者工具的 Network → WS 标签

### 3. 无法加入房间

**症状**: 点击加入按钮没有反应

**解决**:
- 检查房间是否已满
- 检查游戏状态是否为 "等待中"
- 查看控制台是否有错误信息

### 4. 准备状态不同步

**症状**: 点击准备后，自己看到状态改变但其他人看不到

**解决**:
- 检查 WebSocket 连接
- 查看服务器日志
- 刷新页面重试

---

## 调试技巧

### 浏览器开发者工具

1. **Network → WS 标签**
   - 查看 WebSocket 连接状态
   - 查看发送/接收的消息

2. **Console 标签**
   - 查看前端日志
   - 查看错误信息

3. **Application → Local Storage**
   - 查看存储的 token
   - 清除 token 可以重新登录

### 服务器日志

服务器会输出详细的操作日志：
```
[Lobby] Room created: room_xxx by player1
[Lobby] player2 joined room room_xxx
[Lobby] player3 set ready=true in room room_xxx
[Avalon] Game started in room room_xxx, match match_xxx
```

---

## 多账号测试方案

### 方案 1: 多个浏览器

- Chrome（正常模式）- player1
- Chrome（隐身模式）- player2
- Firefox - player3
- Edge - player4
- ...

### 方案 2: 多个隐身窗口

在同一浏览器中：
- 窗口 1（正常）- player1
- 窗口 2（隐身）- player2
- 窗口 3（隐身）- player3
- ...

**提示**: 每个窗口需要单独登录

---

## 下一步

完成游戏大厅测试后，可以继续：

1. **实现阿瓦隆游戏UI**
   - 角色信息面板
   - 任务进度显示
   - 提名和投票界面
   - 刺杀界面

2. **优化体验**
   - 添加音效
   - 添加动画效果
   - 优化移动端适配

3. **添加更多游戏**
   - 文字冒险多人模式
   - 其他桌游（狼人杀、三国杀等）

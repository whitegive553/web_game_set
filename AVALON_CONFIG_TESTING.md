# Avalon 房间配置功能测试指南

## 功能概述

房主在准备阶段可以修改房间配置，包括：
- 目标玩家人数（6-10人）
- 角色配置（哪些角色启用、每个角色数量）

## 测试前提

1. 启动后端服务：`npm run dev:server`
2. 启动前端服务：`npm run dev:client`
3. 创建至少2个测试账号（一个作为房主，一个或多个作为玩家）

---

## 测试场景

### 场景1：单人房主测试配置界面

**步骤：**
1. 使用账号A登录
2. 创建Avalon房间，选择6人局
3. 进入房间后，应该看到：
   - 顶部显示"游戏配置"面板
   - 显示默认6人配置：
     - 善良：梅林1、派西维尔1、忠臣2
     - 邪恶：刺客1、莫甘娜1
   - 房主可以看到"修改配置"按钮

**预期结果：**
✅ 配置面板正确显示
✅ 房主能看到修改按钮
✅ 即使只有房主1人，也能操作配置

---

### 场景2：修改目标人数

**步骤：**
1. 房主点击"修改配置"
2. 点击人数选择器，从6人改为8人
3. 观察角色配置是否自动更新
4. 点击"保存配置"

**预期结果：**
✅ 选择8人后，角色自动调整为：
   - 善良5人：梅林1、派西维尔1、忠臣3
   - 邪恶3人：刺客1、莫甘娜1、爪牙1
✅ 校验信息显示"配置有效"
✅ 保存成功后，玩家数量显示变为"1/8"
✅ 其他玩家（如果有）实时收到配置更新

---

### 场景3：自定义角色配置（启用奥伯伦）

**步骤：**
1. 房主在8人配置基础上点击"修改配置"
2. 减少1个爪牙（点击爪牙的 `-` 按钮）
3. 增加1个奥伯伦（点击奥伯伦的 `+` 按钮）
4. 观察校验信息
5. 点击"保存配置"

**预期结果：**
✅ 配置变为：刺客1、莫甘娜1、奥伯伦1（爪牙0）
✅ 校验显示"配置有效"
✅ 保存成功

---

### 场景4：错误配置校验（总人数不匹配）

**步骤：**
1. 房主点击"修改配置"
2. 减少1个忠臣
3. 观察校验信息

**预期结果：**
✅ 校验信息显示红色错误：
   - "角色总数(7)必须等于目标人数(8)"
✅ "保存配置"按钮被禁用

---

### 场景5：错误配置校验（善恶比例错误）

**步骤：**
1. 房主点击"修改配置"
2. 减少1个忠臣
3. 增加1个刺客（超过1个）

**预期结果：**
✅ 校验显示错误：
   - "刺客最多1个"
✅ "保存配置"按钮被禁用

---

### 场景6：人数限制（不能小于当前玩家数）

**步骤：**
1. 邀请3名玩家加入（共4人）
2. 房主尝试将人数改为6人 ✅ 成功
3. 房主尝试将人数改为3人 ❌ 应该失败

**预期结果：**
✅ 6人选项可以点击
✅ 3人选项被禁用（disabled）
✅ hover提示"当前已有4人"

---

### 场景7：多人配置实时同步

**步骤：**
1. 房主（账号A）和玩家（账号B）都在房间
2. 玩家B观察配置面板
3. 房主A修改人数从6改为9
4. 房主A保存配置

**预期结果：**
✅ 玩家B的界面实时更新：
   - 玩家数量显示变为"2/9"
   - 配置面板显示新的9人配置
   - 不需要刷新页面

---

### 场景8：完整游戏流程（9人局含莫德雷德）

**步骤：**
1. 创建9人房间
2. 邀请8名其他玩家（共9人）
3. 所有玩家准备
4. 房主开始游戏
5. 查看角色分配和视野

**预期结果：**
✅ 角色分配：
   - 善良5人：梅林1、派西维尔1、忠臣3
   - 邪恶4人：刺客1、莫甘娜1、莫德雷德1、爪牙1
✅ 视野规则正确：
   - **梅林**：看到莫甘娜、刺客、爪牙（看不到莫德雷德）
   - **派西维尔**：看到梅林和莫甘娜两个候选
   - **邪恶阵营**（除奥伯伦）：看到所有邪恶队友（包括莫德雷德）
   - **莫德雷德**：看到其他邪恶，但梅林看不到他

---

### 场景9：配置锁定（游戏开始后）

**步骤：**
1. 房主开始游戏
2. 中途返回房间（如果可能）
3. 尝试修改配置

**预期结果：**
✅ 游戏开始后，"修改配置"按钮不可见或禁用
✅ 如果通过API强制调用，应返回错误"Cannot update configuration after game has started"

---

### 场景10：非房主权限测试

**步骤：**
1. 使用非房主账号B进入房间
2. 观察配置面板

**预期结果：**
✅ 配置面板显示当前配置（只读）
✅ 没有"修改配置"按钮
✅ 不能点击人数选择或角色调整

---

## API测试（可选）

使用Postman或curl测试API：

```bash
# 更新配置
curl -X POST http://localhost:3001/api/avalon/{roomId}/config \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{
    "targetPlayerCount": 8,
    "roleConfig": {
      "merlin": 1,
      "percival": 1,
      "loyalServant": 3,
      "assassin": 1,
      "morgana": 1,
      "mordred": 0,
      "oberon": 1,
      "minion": 0
    }
  }'
```

**预期响应：**
```json
{
  "success": true,
  "data": {
    "avalonConfig": {
      "targetPlayerCount": 8,
      "roleConfig": { ... }
    }
  }
}
```

---

## 常见问题排查

### 问题1：配置面板不显示
- 检查是否是Avalon游戏房间
- 检查房间数据是否包含avalonConfig字段
- 查看浏览器console是否有错误

### 问题2：修改后其他玩家没有实时更新
- 检查WebSocket连接是否正常
- 查看是否监听了ROOM_CONFIG_UPDATED事件
- 检查服务端是否正确广播了配置更新

### 问题3：保存配置失败
- 查看错误信息（validation errors）
- 检查是否满足所有校验规则
- 确认当前玩家数不超过目标人数

---

## 回归测试清单

确保新功能没有破坏现有功能：

- [ ] 6人局仍然可以正常创建和开始
- [ ] 7-10人局都能正常运行
- [ ] 原有角色（梅林、派西维尔、忠臣、刺客、莫甘娜、爪牙）视野正常
- [ ] 新角色（莫德雷德、奥伯伦）视野规则正确
- [ ] 游戏流程（提名、投票、任务、刺杀）不受影响
- [ ] 断线重连功能正常
- [ ] 房间持久化正常（重启服务后房间仍在）

---

## 总结

测试通过后，应确保：
1. ✅ 房主可以在准备阶段修改配置
2. ✅ 非房主只能查看配置
3. ✅ 配置修改实时同步给所有玩家
4. ✅ 所有校验规则正确执行
5. ✅ 游戏开始后配置被锁定
6. ✅ 6-10人所有配置都能正常游玩
7. ✅ 新角色视野规则正确实现
